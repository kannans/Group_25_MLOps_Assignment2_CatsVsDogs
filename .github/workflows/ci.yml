name: ML CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  pipeline:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build Docker Image
      run: |
        docker build -t ml-pipeline-image:${{ github.sha }} .

    - name: Run Linting (Black & Flake8)
      run: |
        docker run --rm ml-pipeline-image:${{ github.sha }} black --check --diff src/ tests/
        docker run --rm ml-pipeline-image:${{ github.sha }} flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: Run Unit Tests (Pytest)
      run: |
        docker run --rm ml-pipeline-image:${{ github.sha }} pytest tests/ -v --cov=src --cov-report=xml

    - name: Run Model Training
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        docker run --rm -e MLFLOW_TRACKING_URI=./mlruns ml-pipeline-image:${{ github.sha }} python -m src.train

    - name: Build and Push Final Registry Image
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        echo "Building production image..."
        # In a real scenario, you would login and push here
        # docker push ...
